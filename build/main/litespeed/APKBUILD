# Maintainer: Peter Kokot <peterkokot@gmail.com>

pkgver=1.4.27
# Package release number is started at 100 so it overwrites the official package
pkgrel=100
pkgname=litespeed
_pkgreal=openlitespeed
_pkghome=var/lib/$pkgname
pkgdesc="High-performance, lightweight, open source HTTP server"
url="http://open.litespeedtech.com/"
arch="all !aarch64 !ppc64le"
license="GPL3"
pkgusers=lsadm
pkggroups=lsadm
depends=
depends_dev=
makedepends="php7.1-litespeed linux-headers openssl-dev geoip-dev expat-dev pcre-dev zlib-dev file udns-dev coreutils"
install="$pkgname.pre-install"
subpackages="$pkgname-doc $pkgname-snmp::noarch"
source="http://open.litespeedtech.com/packages/$_pkgreal-$pkgver.tgz
cgiconnection.cpp.patch
configure.patch
devpoller.h.patch
ediostream.cpp.patch
eventreactor.h.patch
fcgiconnection.cpp.patch
functions.sh.patch
httplistener.cpp.patch
httpsession.cpp.patch
install.sh.patch
$pkgname.initd
ls_lock.c.patch
ls_lock.h.patch
lscgid.cpp.patch
lshttpdmain.cpp.patch
multiplexer.cpp.patch
multiplexertest.h.patch
ntwkiolink.cpp.patch
poller.cpp.patch
pollfdreactor.cpp.patch
pthreadmutex.cpp.patch
rtsigio.cpp.patch
thread.h.patch
"
builddir="$srcdir/$_pkgreal-$pkgver"

build() {
  local jobs=$(($(nproc)+1))

  cd "$builddir"

  ./configure \
    --host=$CHOST \
    --build=$CBUILD \
    --prefix=/var/lib/$pkgname \
    --with-user=$pkgusers \
    --with-group=$pkggroups \
    --enable-adminssl=no \
    --disable-rpath \
    --disable-static \
    --with-openssl=/usr \
    --with-expat \
    --with-pcre \
    --with-zlib=/usr \
    --with-lsphp7

  make -j$jobs
}

prepare() {
  cd "$builddir"

  default_prepare

  ln -sf /usr/bin/lsphp "$builddir"/dist/fcgi-bin/lsphp
  rm "$builddir"/dist/admin/misc/php.ini
  rm "$builddir"/dist/admin/conf/php.ini
}

check() {
  cd "$builddir"

  local allow_fail='yes'

  make test || [ "$allow_fail" = yes ]
}

package() {
  local file;

  cd "$builddir"

  # Create necessary users
  sudo "$builddir"/../../$pkgname.pre-install

  make DESTDIR="$pkgdir" install

  mkdir -p "$pkgdir"/usr/lib/$pkgname \
    "$pkgdir"/usr/sbin \
    "$pkgdir"/var/log

  # Remove some not used files
  #rm -rf "$pkgdir"/$_pkghome/php* \
  #  "$pkgdir"/$_pkghome/lib \
  #  "$pkgdir"/$_pkghome/GPL* \
  #  "$pkgdir"/$_pkghome/gdata \
  #  "$pkgdir"/$_pkghome/autoupdate \
  #  "$pkgdir"/$_pkghome/fcgi-bin/* \
  #  "$pkgdir"/$_pkghome/bin/lshttpd \
  #  "$pkgdir"/$_pkghome/admin/misc/gdb-bt \
  #  "$pkgdir"/$_pkghome/admin/misc/convertxml.* \
  #  "$pkgdir"/$_pkghome/admin/misc/build_admin_php.sh

  # fix permissions
  chown -R $pkgusers:$pkggroups \
    "$pkgdir"/$_pkghome/conf \
    "$pkgdir"/$_pkghome/admin/conf

  #chown -R $pkgusers:$pkggroups \
  #  "$pkgdir"/$_pkghome/tmp \
  #  "$pkgdir"/$_pkghome/conf \
  #  "$pkgdir"/$_pkghome/logs \
  #  "$pkgdir"/$_pkghome/backup \
  #  "$pkgdir"/$_pkghome/cachedata \
  #  "$pkgdir"/$_pkghome/admin/tmp \
  #  "$pkgdir"/$_pkghome/admin/logs \
  #  "$pkgdir"/$_pkghome/admin/conf \
  #  "$pkgdir"/$_pkghome/Example/logs

  # Install configs
  install -Dm755 "$srcdir"/$pkgname.initd \
    "$pkgdir"/etc/init.d/$pkgname
  mv "$pkgdir"/$_pkghome/conf \
    "$pkgdir"/etc/$pkgname
  mv "$pkgdir"/$_pkghome/admin/conf \
    "$pkgdir"/etc/$pkgname/admin
  ln -s /etc/$pkgname "$pkgdir"/$_pkghome/conf
  ln -s /etc/$pkgname/admin "$pkgdir"/$_pkghome/admin/conf
  find "$pkgdir"/etc/$pkgname -type f -print0 | xargs -0 chmod -x

  # Install binaries
  mv "$pkgdir"/$_pkghome/bin/$_pkgreal \
    "$pkgdir"/usr/sbin/lshttpd
  ln -sf /usr/sbin/lshttpd \
    "$pkgdir"/$_pkghome/bin/$_pkgreal
  ln -sf /usr/bin/lsphp \
    "$pkgdir"/$_pkghome/fcgi-bin/lsphp

  # Install modules
  for file in $(find "$pkgdir"/$_pkghome/modules -name "*.so"); do
    mv $file "$pkgdir"/usr/lib/$pkgname/${file##*/}
    ln -s /usr/lib/$pkgname/${file##*/} $file
  done

  # Install logs
  mv "$pkgdir"/$_pkghome/logs "$pkgdir"/var/log/$pkgname
  mv "$pkgdir"/$_pkghome/admin/logs "$pkgdir"/var/log/$pkgname/admin
  mv "$pkgdir"/$_pkghome/Example/logs "$pkgdir"/var/log/$pkgname/Example
  ln -s /var/log/$pkgname "$pkgdir"/$_pkghome/logs
  ln -s /var/log/$pkgname/admin "$pkgdir"/$_pkghome/admin/logs
  ln -s /var/log/$pkgname/Example "$pkgdir"/$_pkghome/Example/logs
}

doc() {
  default_doc

  mkdir -p "$subpkgdir"/var/lib/$pkgname/docs
  mv "$pkgdir"/$_pkghome/docs/* \
    "$subpkgdir"/$_pkghome/docs
}

snmp() {
  pkgdesc="$pkgdesc (snmp monitoring add-on + cacti templates)"
  depends="$pkgname net-snmp"

  mkdir -p "$subpkgdir"/$_pkghome/add-ons
  mv "$pkgdir"/$_pkghome/add-ons/snmp_monitoring \
    "$subpkgdir"/$_pkghome/add-ons
}
sha512sums="ee31a178efc2b130529310d7ba78cd489758b57f44b427bdc075a5b6bd40d5a1678754158fcfd72b965b51a67a62a1f8e363f3f636b5f83e3303f231d3edbc11  openlitespeed-1.4.27.tgz
b93c745d458b3cad491cb100afbfc10ad4247cac16ba3db0cfbd87b35681ea5608e8939c6748ec05b6061d1ad1560bc2f12ba43299cd436490b43ffbc21b7800  cgiconnection.cpp.patch
0e73b296ad9fa935584bbc5f38ef9201e7bf4b0d4c0ddac37dd81e7fbc11bb04f0cf6c4affb88fac981e1b1600db95adc5047b1c25c7a7906c2620e3f6759320  configure.patch
1e527634c4350cf4b33cee54fe72bcb059f87a97e3029248185cad467ed70115df7087312c36343315d7028182e2bdf595e60e4166f24d91faf1b8c304b33917  devpoller.h.patch
b10c06fb9a82ded80466d523a9987c0fd27c2d8a3e8a308043a349021c83b01428b65939e4c30e8d450cb54e4acedca43c6972f33a6693407f16191ebfbce29e  ediostream.cpp.patch
82acb5409eeae5cea0ba7051f3a8db85c8ba55b04967b96a0258fdbd855f80c765a522e9243d06f94a8e351ac920483887919361ae80955ea99ae6914d300d29  eventreactor.h.patch
7d16decd3ddd91714d35292c81d422294a57d3702e1ec3a56fc6fccb8342627cb7fdbdf5121bbeb71734882d646cde51d8b23d7c84e9ea806fa4735ed6417b0f  fcgiconnection.cpp.patch
b81d455ee44297c32a443abd733682c644028bccbe78714f70ce83feb73a7650e119f4560306048b9812d1a8316014dc97c8732a97e17af7b7fbd41bfed0d558  functions.sh.patch
8c614c6c9818f947b2bdb7044e389eeeda3885b57b908573f0afeb46935c1508c23e2ae257af2ec92a5898e3a5d142da10b4d5ff2af7c282f52d35ffa39379eb  httplistener.cpp.patch
aa65e2de86041c24284f941a1583c099a2575262c7f0b09d1ef04df2629c3ee0282c013fc7a87b0049587604b808fef8d7121a5cd82f1aff8cf32cdba238962c  httpsession.cpp.patch
9e62dae08ce4a89d2efca2923e6472749cf784f3764c12badf00aafdaf33be4cfa732bc45e6242ed78e23e5e6ac3594d90fd3b1ac548b6b263cd7d446304f017  install.sh.patch
a2c7826cbcb1cc7ad3745d31d2f0c189fb43844a2c465de075f2e563bf68cdbe532339f4e34b4379472bc5d0bdd34f64f92ea87c3df8c054a3b694be8a52bc3b  litespeed.initd
ed5d1a270e7dc83d8ccc881b534a3f4efaaa504b2da91405a4c0b54375ff0eea33a415e84f21c900a5f85c2f671beeec807f242ef10a150471be94c651037abb  ls_lock.c.patch
f4d54305df247b16dcacba92f7c5d446758143857602062d5b7c68c01b0c4072a7a46d3ae246d7018700ecb73755ce4e4d1dba1f49169bddea9584d85cfb2f43  ls_lock.h.patch
cbccf5aa74f7dbc1c3fb70180e350cf2fc70cb149b2dbdad5ff8ec994ccc36962665a8904ca891d32c17859b8e9429956ff1bced132d9ce3d3d8e0461035d53a  lscgid.cpp.patch
6a38b58187d9c29b723e518946d67ff575452217fc6c15c9da23a5c780b6c7eab80ffa7ba1a8ed9737f5434a1dec6bd3fc6d87a030902b4a97efcc96de7b9f85  lshttpdmain.cpp.patch
01aad3cbbab954ada49869c8b992d6a0a3ac3c4d10b3b929d3e8bf0fb866fb0435f0ab1f477e4d1385ec4447078ea150fe326387f369febd925535d0125a0a3e  multiplexer.cpp.patch
0f3230817f5e7c51c29193bf446e82eb56814a041cfd10fc61b8a49fadf53d19214a489dd120ffe9c4cc4b3839ead121be35bf5e9f08f4d11bb18b0f75e4d738  multiplexertest.h.patch
d774a8ba325ac0403df282705daff57b994e30d12f3e3ddb136f9ccc4a5309e76143bd2cc3173bbbccf1343187465fbfab82f9fa6d8e7dd0607ef648bb5bfcc5  ntwkiolink.cpp.patch
e49a721ef0ba12c04f9a4207230245abd1c0e3ec32ddada14af78c17abaecdcb722c191d9bddb81f547954b455bfa47285da9724dea01aacecf3302df491e71d  poller.cpp.patch
e6a7acdd61439a01646ac215986677dfc5fde4e990f6ccfd27d43cf7f312ea6560f58412bb3e2ca2473504c85f729f21a2920f5fe39d4269b76f9866dc964f3e  pollfdreactor.cpp.patch
4791f1d3b5cf24aee296ca04a537ac5c5a04349887fa4e47c44aa1c396262827e189c755ce38c95e1bdfcd6a2c5510f531e440eb405ed664f735030b65f11fb5  pthreadmutex.cpp.patch
709a20f40d357b195d1b077cfd99a4ee63293893343cfe82a8a0335c14d6f44affc0b159383c8a3dac777ab3384eec7031ab3ac4c286f9d50604a6b418ab300f  rtsigio.cpp.patch
18b77eda64ea68c2eb3fe0ab02957a03c65d0d12f1e9ad9766e38c28602db7736ef0a2b8045a4e44916d712f5f01813520e04835ee7fbd1cf34d76afc39dc0d4  thread.h.patch"
